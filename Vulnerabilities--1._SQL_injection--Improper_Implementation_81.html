<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Improper Implementation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Improper Implementation</h1><br/><p><ul><li>Consider the following sample Express framework router which queries a MySQL database.<ul><li><ul><li></li></ul></li></ul></li></ul><div class="codebox"><pre>const express = require<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;express&#39;</span><span style="color:#ff9d00;font-weight:700">);</span><br />const db = require<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;./db&#39;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><br />const router = express.Router<span style="color:#ff9d00;font-weight:700">();</span><br /><br />router.get<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;/email&#39;</span>, <span style="color:#333333;font-weight:400">(req, res)</span> =<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#ff9d00;font-weight:700">{</span><br />	db.query<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;SELECT email FROM users WHERE id = &#39;</span> + req.query.id<span style="color:#ff9d00;font-weight:700">);</span><br />		.then<span style="color:#ff9d00;font-weight:700">((</span>record<span style="color:#ff9d00;font-weight:700">)</span> =<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#ff9d00;font-weight:700">{</span><br />			<span style="color:#ff9d00;font-weight:700">//</span> <span style="color:#ff9d00;font-weight:700">do</span> stuff<br />			res.send<span style="color:#ff9d00;font-weight:700">(</span>record[0]<span style="color:#ff9d00;font-weight:700">);</span><br />		<span style="color:#ff9d00;font-weight:700">})</span><br />	<span style="color:#ff9d00;font-weight:700">});</span></pre></div><ul><li>The application gets the user id from the URL and queries the database to retrieve its email address.</li><li>There are two things wrong with this example:<ul><li>1. The database query is built via a String concatenation</li><li>2. User input, which should always be handled as untrusted and unsafe data, is concatenated to the query</li></ul></li><li>A numerical query string id parameter would lead to an expectable query like the one below;<ul><li></li></ul></li></ul><div class="codebox"><pre>SELECT email FROM users WHERE id = 1</pre></div><ul><li>However a well crafted query string id parameter may dump all table names available in current database. Consider the following query string parameter id value<ul><li></li></ul></li></ul><div class="codebox"><pre>1 UNION SELECT group_concat<span style="color:#ff9d00;font-weight:700">(</span>table_name<span style="color:#ff9d00;font-weight:700">)</span> FROM information_schema.tables WHERE table_name = database<span style="color:#ff9d00;font-weight:700">()</span></pre></div><ul><li>The resulting query would look like;<ul><li></li></ul></li></ul><div class="codebox"><pre>SELECT email FROM users WHERE id = 1 UNION SELECT group_concat<span style="color:#ff9d00;font-weight:700">(</span>table_name<span style="color:#ff9d00;font-weight:700">)</span> FROM information_schema.tables WHERE table_name = database<span style="color:#ff9d00;font-weight:700">()</span></pre></div><ul><li>This would put the list of all database tables on the screen. Then, the attacker can continue retrieving whatever information he/she wants from the database.</li><li>Ultimately, with the right permissions, the attacker can even write files to the disk. Consider the following value to the query string parameter id<ul><li></li></ul></li></ul><div class="codebox"><pre>1 UNION SELECT <span style="color:#3ad900;font-weight:400">&quot;&lt;h1&gt;hello world&lt;/h1&gt;&quot;</span> INTO OUTFILE <span style="color:#3ad900;font-weight:400">&quot;/home/website/public_html&quot;</span></pre></div><ul><li>Leading to the following query to be executed;<ul><li></li></ul></li></ul><div class="codebox"><pre>SELECT email FROM users WHERE id = 1 UNION SELECT <span style="color:#3ad900;font-weight:400">&quot;&lt;h1&gt;hello world&lt;/h1&gt;&quot;</span> INTO OUTFILE <span style="color:#3ad900;font-weight:400">&quot;/home/website/public_htm</span></pre></div></p><p><ul><li>String Concatenation<ul><li>You should never use string concatenation in combination with the client input value. Take an example wherethe existence (not the value) of a client input variable “surname” is used to construct the SQL query of the prepared statement;</li><li></li></ul></li></ul><div class="codebox"><pre>1 String query = “select id, frstname, lastname FROM authors”<span style="color:#ff9d00;font-weight:700">;</span><br />2<br />3 <span style="color:#ff9d00;font-weight:700">if</span> <span style="color:#ff9d00;font-weight:700">((</span> <span style="color:#7f0044;font-weight:400">frstname</span> != <span style="color:#7f0044;font-weight:400">NULL</span> <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#7f0044;font-weight:400">frstname</span>.<span style="color:#7f0044;font-weight:400">length</span> != <span style="color:#ff0044;font-weight:400">0</span> ) <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#ff9d00;font-weight:700">(</span> <span style="color:#7f0044;font-weight:400">lastname</span> != <span style="color:#7f0044;font-weight:400">NULL</span> <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#7f0044;font-weight:400">lastname</span>.<span style="color:#7f0044;font-weight:400">length</span> != <span style="color:#ff0044;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">)</span>) {<br /><span style="color:#ff0044;font-weight:400">4</span>    <span style="color:#7f0044;font-weight:400">query</span> += “<span style="color:#7f0044;font-weight:400">WHERE</span> <span style="color:#7f0044;font-weight:400">forename</span> = ? <span style="color:#7f0044;font-weight:400">AND</span> <span style="color:#7f0044;font-weight:400">surname</span> = ?”;<br /><span style="color:#ff0044;font-weight:400">5</span> }<br /><span style="color:#ff0044;font-weight:400">6</span> <span style="color:#7f0044;font-weight:400">else</span> <span style="color:#7f0044;font-weight:400">if</span> <span style="color:#ff9d00;font-weight:700">(</span> <span style="color:#7f0044;font-weight:400">frstname</span> != <span style="color:#7f0044;font-weight:400">NULL</span> <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#7f0044;font-weight:400">frstname</span>.<span style="color:#7f0044;font-weight:400">length</span> != <span style="color:#ff0044;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">)</span> {<br /><span style="color:#ff0044;font-weight:400">7</span>     <span style="color:#7f0044;font-weight:400">query</span> += “<span style="color:#7f0044;font-weight:400">WHERE</span> <span style="color:#7f0044;font-weight:400">forename</span> = ?”;<br /><span style="color:#ff0044;font-weight:400">8</span> }<br /><span style="color:#ff0044;font-weight:400">9</span> <span style="color:#7f0044;font-weight:400">else</span> <span style="color:#7f0044;font-weight:400">if</span> <span style="color:#ff9d00;font-weight:700">(</span> <span style="color:#7f0044;font-weight:400">lastname</span>!= <span style="color:#7f0044;font-weight:400">NULL</span> <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#7f0044;font-weight:400">lastname</span>.<span style="color:#7f0044;font-weight:400">length</span> != <span style="color:#ff0044;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">)</span> {<br /><span style="color:#ff0044;font-weight:400">10</span>     <span style="color:#7f0044;font-weight:400">query</span> += “<span style="color:#7f0044;font-weight:400">WHERE</span> <span style="color:#7f0044;font-weight:400">surname</span> = ?”;<br /><span style="color:#ff0044;font-weight:400">11</span> }<br /><span style="color:#ff0044;font-weight:400">12</span><br /><span style="color:#ff0044;font-weight:400">13</span> <span style="color:#7f0044;font-weight:400">query</span> += “;”;<br /><span style="color:#ff0044;font-weight:400">14</span><br /><span style="color:#ff0044;font-weight:400">15</span> <span style="color:#7f0044;font-weight:400">PreparedStatement</span> <span style="color:#7f0044;font-weight:400">pstmt</span> = <span style="color:#7f0044;font-weight:400">connection</span>.<span style="color:#7f0044;font-weight:400">prepareStatement</span><span style="color:#ff9d00;font-weight:700">(</span> <span style="color:#7f0044;font-weight:400">query</span> <span style="color:#ff9d00;font-weight:700">)</span></pre></div><ul><li>This logic will be fine when either frstname, or lastname is given, however if neither were given then the SQL statement would not have any WHERE clause, and the entire table would be returned. This is not an SQL injection (theattacker has done nothing to cause this situation, except not passing two values) however the end result is the same,information has been leaked from the database, despite the fact that a parameterized query was used. </li></ul></p></div>
</body>
</html>
